<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Billing & Payment - FIFTY 50 MEDTECHIE</title>
  <link rel="stylesheet" href="style.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" />
</head>
<body>
  <!-- Top header: logo left, Patient right -->
  <header class="dash-topbar">
    <div class="topbar-inner">
      <button class="menu-btn" id="btnToggle" aria-label="Toggle menu"><i class="fa-solid fa-bars"></i></button>
      <div class="brand">
        <img src="../logo.png" alt="FIFTY 50 MEDTECHIE" />
        <div class="brand-text">
          <h2>FIFTY 50 MEDTECHIE</h2>
          <small>"Trust Us... If You’re Feeling Lucky."</small>
        </div>
      </div>
      <div class="top-right">
        <select id="roleSel" title="Role"></select>
        <select id="branchSel" title="Branch"></select>
        <span class="role"><i class="fa-regular fa-user"></i> <span id="roleText">Role</span></span>
        <span class="role" style="margin-left:8px;"><i class="fa-solid fa-code-branch"></i> <span id="branchText">Branch</span></span>
      </div>
    </div>
  </header>

  <!-- Sidebar Layout (unified) -->
  <div class="layout">
    <aside class="simple-sidebar" id="sidebar">
      <nav class="side-nav">
        <a href="dashboard.html" data-feature="dashboard">Dashboard</a>
        <a href="registration-records.html" data-feature="ehr">Registration & Records</a>
        <a href="scheduling.html" data-feature="scheduling">Scheduling</a>
        <a href="billing.html" class="active" data-feature="billing">Billing & Payment</a>
        <a href="laboratory.html" data-feature="laboratory">Laboratory & Diagnostic</a>
        <a href="pharmacy.html" data-feature="pharmacy">Pharmacy</a>
        <a href="reports.html" data-feature="reports">Reports & Analytics</a>
      </nav>
    </aside>

    <main class="content">
      <h1 class="page-title">Billing & Payment</h1>

      <!-- KPIs / Summary -->
      <section class="kpi-grid" style="margin-bottom:14px;">
        <article class="kpi-card kpi-info">
          <div class="kpi-head"><span>Total Outstanding</span><i class="fa-solid fa-receipt"></i></div>
          <div class="kpi-value" id="kpiOutstanding">₱0</div>
          <div class="kpi-sub up"><i class="fa-solid fa-arrow-trend-up"></i> Updated live</div>
        </article>
        <article class="kpi-card kpi-success">
          <div class="kpi-head"><span>Paid Invoices</span><i class="fa-solid fa-circle-check"></i></div>
          <div class="kpi-value" id="kpiPaid">0</div>
          <div class="kpi-sub up">Thank you!</div>
        </article>
        <article class="kpi-card kpi-warning">
          <div class="kpi-head"><span>Unpaid Invoices</span><i class="fa-solid fa-triangle-exclamation"></i></div>
          <div class="kpi-value" id="kpiUnpaid">0</div>
          <div class="kpi-sub down">Settle soon</div>
        </article>
        <article class="kpi-card kpi-primary">
          <div class="kpi-head"><span>Last Payment</span><i class="fa-solid fa-peso-sign"></i></div>
          <div class="kpi-value" id="kpiLast">—</div>
          <div class="kpi-sub">Most recent receipt</div>
        </article>
      </section>

      <!-- Actions -->
      <section class="actions">
        <button class="action-btn" id="btnAddDemo"><i class="fa-solid fa-file-circle-plus"></i> Add Demo Invoice</button>
        <button class="action-btn" id="btnClear"><i class="fa-solid fa-broom"></i> Clear Demo Data</button>
        <button class="action-btn" id="btnPayTop"><i class="fa-solid fa-money-bill"></i> Pay Selected</button>
        <button class="action-btn" id="btnRefresh"><i class="fa-solid fa-rotate"></i> Refresh</button>
      </section>

      <!-- Invoices List -->
      <section class="form-container">
        <h3><i class="fa-solid fa-receipt"></i> Invoices</h3>
        <div class="row">
          <div>
            <label for="filterInv">Search (Patient / Invoice #)</label>
            <input id="filterInv" type="text" placeholder="Type to filter">
          </div>
          <div>
            <label for="statusSel">Status</label>
            <select id="statusSel">
              <option value="all">All</option>
              <option value="unpaid">Unpaid</option>
              <option value="paid">Paid</option>
            </select>
          </div>
        </div>
        <div id="invoiceList" style="margin-top:10px;"></div>
      </section>

      <!-- Payment Form -->
      <section class="form-container">
        <h3><i class="fa-solid fa-coins"></i> Process Payment</h3>
        <div class="row">
          <div>
            <label for="payInvoice">Invoice</label>
            <select id="payInvoice"></select>
          </div>
          <div>
            <label for="payAmount">Amount</label>
            <input id="payAmount" type="number" min="0" step="0.01" placeholder="0.00">
          </div>
        </div>
        <div class="row">
          <div>
            <label for="payMethod">Payment Method</label>
            <select id="payMethod">
              <option>Cash</option>
              <option>GCash</option>
              <option>Bank Transfer</option>
              <option>Card</option>
            </select>
          </div>
          <div>
            <label for="payRef">Reference No. (optional)</label>
            <input id="payRef" type="text" placeholder="e.g., GCash Ref, OR #">
          </div>
        </div>
        <button class="submit-btn" id="btnPay"><i class="fa-solid fa-check"></i> Submit Payment</button>
      </section>

      <!-- Payment History -->
      <section class="form-container">
        <h3><i class="fa-solid fa-clipboard-list"></i> Recent Payments</h3>
        <div id="paymentList"></div>
      </section>

      <!-- Insurance & Claims (Accountant/Admin only) -->
      <section class="form-container" data-feature="insurance">
        <h3><i class="fa-solid fa-file-shield"></i> Insurance & Claims</h3>
        <div class="row">
          <div>
            <label for="insInvoice">Invoice</label>
            <select id="insInvoice"></select>
          </div>
          <div>
            <label for="insInsurer">Insurer</label>
            <input id="insInsurer" type="text" placeholder="e.g., PhilHealth / HMO">
          </div>
        </div>
        <div class="row">
          <div>
            <label for="insPolicy">Policy / Member No.</label>
            <input id="insPolicy" type="text" placeholder="Policy or Member #">
          </div>
          <div>
            <label for="insCoverage">Coverage %</label>
            <input id="insCoverage" type="number" min="0" max="100" step="1" placeholder="e.g., 80">
          </div>
          <div>
            <label for="insStatus">Claim Status</label>
            <select id="insStatus">
              <option>Pending</option>
              <option>Submitted</option>
              <option>Approved</option>
              <option>Denied</option>
            </select>
          </div>
        </div>
        <div class="row">
          <div>
            <small id="insCalc" class="muted">Claim Amount: —</small>
          </div>
        </div>
        <div style="margin-top:8px;">
          <button class="submit-btn" id="btnClaimSubmit"><i class="fa-solid fa-paper-plane"></i> Submit/Update Claim</button>
        </div>
      </section>

      <section class="form-container" data-feature="insurance">
        <h3><i class="fa-solid fa-list-check"></i> Claims</h3>
        <div id="claimsList"></div>
      </section>
    </main>
  </div>

  <script src="rbac.js"></script>
  <script>
    // Sidebar collapse toggle
    const btn = document.getElementById('btnToggle');
    const sidebar = document.getElementById('sidebar');
    if (btn && sidebar) {
      btn.addEventListener('click', () => sidebar.classList.toggle('collapsed'));
    }

    // Demo storage
    const INV_KEY = 'hms_invoices';
    const PAY_KEY = 'hms_payments';
    const CLAIM_KEY = 'hms_claims';
    const store = {
      invAll: () => JSON.parse(localStorage.getItem(INV_KEY) || '[]'),
      invSave: (arr) => localStorage.setItem(INV_KEY, JSON.stringify(arr)),
      payAll: () => JSON.parse(localStorage.getItem(PAY_KEY) || '[]'),
      paySave: (arr) => localStorage.setItem(PAY_KEY, JSON.stringify(arr)),
      claimAll: () => JSON.parse(localStorage.getItem(CLAIM_KEY) || '[]'),
      claimSave: (arr) => localStorage.setItem(CLAIM_KEY, JSON.stringify(arr)),
    };

    // Elements
    const filterInv = document.getElementById('filterInv');
    const statusSel = document.getElementById('statusSel');
    const invoiceList = document.getElementById('invoiceList');
    const paymentList = document.getElementById('paymentList');
    const payInvoice = document.getElementById('payInvoice');
    const payAmount = document.getElementById('payAmount');
    const payMethod = document.getElementById('payMethod');
    const payRef = document.getElementById('payRef');
    // Insurance elements
    const insInvoice = document.getElementById('insInvoice');
    const insInsurer = document.getElementById('insInsurer');
    const insPolicy = document.getElementById('insPolicy');
    const insCoverage = document.getElementById('insCoverage');
    const insStatus = document.getElementById('insStatus');
    const insCalc = document.getElementById('insCalc');
    const claimsList = document.getElementById('claimsList');
    const btnClaimSubmit = document.getElementById('btnClaimSubmit');

    // Utils
    const peso = n => '₱' + (Number(n).toLocaleString('en-PH', { minimumFractionDigits: 2, maximumFractionDigits: 2 }));

    function totals() {
      const invs = store.invAll();
      let paid = 0, unpaid = 0, outstanding = 0;
      invs.forEach(i => {
        const paidAmt = (i.payments || []).reduce((s,p)=>s+Number(p.amount||0),0);
        const remain = Math.max(0, Number(i.total) - paidAmt);
        outstanding += remain;
        if (remain === 0) paid++; else unpaid++;
      });
      return { paid, unpaid, outstanding };
    }

    function renderKPIs() {
      const t = totals();
      document.getElementById('kpiOutstanding').textContent = peso(t.outstanding);
      document.getElementById('kpiPaid').textContent = t.paid;
      document.getElementById('kpiUnpaid').textContent = t.unpaid;

      const pays = store.payAll().sort((a,b)=> new Date(b.date) - new Date(a.date));
      document.getElementById('kpiLast').textContent = pays[0] ? peso(pays[0].amount) : '—';
    }

    function renderInvoices() {
      const q = (filterInv.value || '').toLowerCase();
      const status = statusSel.value;
      const invs = store.invAll().sort((a,b)=> new Date(b.date) - new Date(a.date));

      const list = invs.filter(i => {
        const paidAmt = (i.payments || []).reduce((s,p)=>s+Number(p.amount||0),0);
        const remain = Math.max(0, Number(i.total) - paidAmt);
        const isPaid = remain === 0;
        const statusOk = status === 'all' || (status === 'paid' && isPaid) || (status === 'unpaid' && !isPaid);
        const qOk = !q || i.patient.toLowerCase().includes(q) || i.no.toLowerCase().includes(q);
        return statusOk && qOk;
      });

      if (!list.length) { invoiceList.innerHTML = '<p class="muted">No invoices found.</p>'; return; }

      invoiceList.innerHTML = list.map(i => {
        const paidAmt = (i.payments || []).reduce((s,p)=>s+Number(p.amount||0),0);
        const remain = Math.max(0, Number(i.total) - paidAmt);
        const isPaid = remain === 0;
        const badge = isPaid ? '<span style="color:#166534;background:#dcfce7;padding:2px 8px;border-radius:999px;font-weight:700;">Paid</span>' : '<span class="low">Unpaid</span>';
        return `
          <div class="record">
            <p><strong>${i.patient}</strong> — Invoice <strong>#${i.no}</strong><br>
            <span class="muted">${new Date(i.date).toLocaleDateString()}</span></p>
            <div class="actions">
              <p><strong>Total:</strong> ${peso(i.total)}<br><small>Remaining: ${peso(remain)}</small></p>
              ${badge}
              <button class="btn-view" onclick="selectInvoice('${i.no}')">Select</button>
            </div>
          </div>`;
      }).join('');
    }

    function renderPaymentForm() {
      const invs = store.invAll();
      const selected = sessionStorage.getItem('billing_selected');
      payInvoice.innerHTML = invs.map(i => `<option value="${i.no}" ${selected===i.no?'selected':''}>#${i.no} — ${i.patient}</option>`).join('');
      // mirror for insurance invoice select
      if (insInvoice) {
        insInvoice.innerHTML = payInvoice.innerHTML;
        if (selected) insInvoice.value = selected;
      }
    }

    function renderPayments() {
      const pays = store.payAll().sort((a,b)=> new Date(b.date) - new Date(a.date));
      if (!pays.length) { paymentList.innerHTML = '<p class="muted">No payments yet.</p>'; return; }
      paymentList.innerHTML = pays.map(p => `
        <div class="record">
          <p><strong>${p.patient}</strong> — Invoice <strong>#${p.no}</strong><br>
          <span class="muted">${new Date(p.date).toLocaleString()}</span></p>
          <div class="actions">
            <p><strong>${peso(p.amount)}</strong><br><small>${p.method}${p.ref?(' · Ref: '+p.ref):''}</small></p>
          </div>
        </div>`).join('');
    }

    // Selection helper for inline buttons
    window.selectInvoice = function(no) {
      sessionStorage.setItem('billing_selected', no);
      renderPaymentForm();
      document.getElementById('btnPayTop').scrollIntoView({ behavior: 'smooth', block: 'center' });
    };

    // Actions
    document.getElementById('btnClear').onclick = () => { localStorage.removeItem(INV_KEY); localStorage.removeItem(PAY_KEY); sessionStorage.removeItem('billing_selected'); seed(); };
    document.getElementById('btnRefresh').onclick = () => { renderAll(); };
    document.getElementById('btnPayTop').onclick = () => { document.getElementById('btnPay').click(); };
    document.getElementById('btnAddDemo').onclick = () => {
      const invs = store.invAll();
      const id = 'INV' + Math.random().toString(36).slice(2,6).toUpperCase();
      invs.push({ no: id, patient: 'Demo Patient', date: new Date().toISOString(), items: [{ name: 'Consultation', price: 500 }], total: 500, payments: [] });
      store.invSave(invs); renderAll(); alert('Demo invoice added: #' + id);
    };

    document.getElementById('btnPay').onclick = () => {
      const no = payInvoice.value;
      const amount = Number(payAmount.value || 0);
      const method = payMethod.value;
      const ref = payRef.value.trim();
      if (!no || amount <= 0) { alert('Select invoice and enter a valid amount.'); return; }

      const invs = store.invAll();
      const inv = invs.find(i => i.no === no);
      if (!inv) { alert('Invoice not found.'); return; }
      const paidAmt = (inv.payments || []).reduce((s,p)=>s+Number(p.amount||0),0);
      const remain = Math.max(0, Number(inv.total) - paidAmt);
      if (amount > remain) {
        if (!confirm('Amount exceeds remaining (' + peso(remain) + '). Continue?')) return;
      }

      const payment = { no, patient: inv.patient, amount, method, ref, date: new Date().toISOString() };
      // Save payment
      const pays = store.payAll(); pays.push(payment); store.paySave(pays);
      // Link to invoice
      inv.payments = inv.payments || []; inv.payments.push({ amount, method, ref, date: payment.date });
      store.invSave(invs);

      payAmount.value = ''; payRef.value = '';
      sessionStorage.setItem('billing_selected', no);
      renderAll();
      alert('Payment recorded: ' + peso(amount));
    };

    filterInv.oninput = renderInvoices; statusSel.onchange = renderInvoices;

    function renderAll() { renderKPIs(); renderInvoices(); renderPaymentForm(); renderPayments(); renderClaims(); calcClaimAmount(); }

    // Seed demo data if empty
    function seed() {
      if (!store.invAll().length) {
        const now = new Date();
        const invs = [
          { no: 'INV1001', patient: 'Juan Dela Cruz', date: new Date(now.getFullYear(), now.getMonth(), now.getDate()-2).toISOString(), items: [{ name: 'Consultation', price: 500 }, { name: 'CBC', price: 300 }], total: 800, payments: [] },
          { no: 'INV1002', patient: 'Maria Clara', date: new Date(now.getFullYear(), now.getMonth(), now.getDate()-1).toISOString(), items: [{ name: 'X-Ray', price: 1200 }], total: 1200, payments: [{ amount: 1200, method: 'Cash', date: new Date().toISOString() }] }
        ];
        store.invSave(invs);
        store.paySave([{ no: 'INV1002', patient: 'Maria Clara', amount: 1200, method: 'Cash', date: new Date().toISOString() }]);
      }
      renderAll();
    }

    seed();
  </script>
</body>
</html>
