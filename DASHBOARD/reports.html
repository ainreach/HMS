<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>HMS - Reports & Analytics</title>
  <link rel="stylesheet" href="style.css" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" integrity="sha512-1ycn6IcaQQ40/MKBW2W4Rhis/DbILU74C1vSrLJxCq57o941Ym01SwNsOMqvEBFlcgUa6xLiPY/NS5R+E6ztJQ==" crossorigin="anonymous" referrerpolicy="no-referrer" />
</head>
<body>
  <header class="dash-topbar">
    <div class="topbar-inner">
      <button class="menu-btn" id="btnToggle" aria-label="Toggle menu"><i class="fa-solid fa-bars"></i></button>
      <div class="brand">
        <img src="../logo.png" alt="FIFTY 50 MEDTECHIE" />
        <div class="brand-text">
          <h2>FIFTY 50 MEDTECHIE</h2>
          <small>"Trust Us... If You’re Feeling Lucky."</small>
        </div>
      </div>
      <div class="top-right">
        <select id="roleSel" title="Role"></select>
        <select id="branchSel" title="Branch"></select>
        <span class="role"><i class="fa-regular fa-user"></i> <span id="roleText">Role</span></span>
        <span class="role" style="margin-left:8px;"><i class="fa-solid fa-code-branch"></i> <span id="branchText">Branch</span></span>
      </div>
    </div>
  </header>

  <div class="layout">
    <aside class="simple-sidebar" id="sidebar">
      <nav class="side-nav">
        <a href="dashboard.html" data-feature="dashboard">Dashboard</a>
        <a href="registration-records.html" data-feature="ehr">Registration & Records</a>
        <a href="scheduling.html" data-feature="scheduling">Scheduling</a>
        <a href="billing.html" data-feature="billing">Billing & Payment</a>
        <a href="laboratory.html" data-feature="laboratory">Laboratory & Diagnostic</a>
        <a href="pharmacy.html" data-feature="pharmacy">Pharmacy</a>
        <a href="reports.html" class="active" data-feature="reports">Reports & Analytics</a>
      </nav>
    </aside>

    <main class="content">
      <h1 class="page-title">Reports & Analytics</h1>

      <section class="kpi-grid">
        <div class="kpi-card">
          <div class="kpi-title">Appointments Today</div>
          <div class="kpi-value" id="kpiAppt">0</div>
        </div>
        <div class="kpi-card">
          <div class="kpi-title">Outstanding Balance</div>
          <div class="kpi-value" id="kpiOutstanding">₱0.00</div>
        </div>
        <div class="kpi-card">
          <div class="kpi-title">Lab Orders In-Process</div>
          <div class="kpi-value" id="kpiLab">0</div>
        </div>
        <div class="kpi-card">
          <div class="kpi-title">Low Stock Items</div>
          <div class="kpi-value" id="kpiStock">0</div>
        </div>
      </section>

      <section class="form-container">
        <h3><i class="fa-solid fa-download"></i> Export Data</h3>
        <div class="row">
          <div>
            <label>Dataset</label>
            <select id="dataset">
              <option value="appointments">Appointments</option>
              <option value="invoices">Invoices</option>
              <option value="payments">Payments</option>
            </select>
          </div>
          <div style="align-self:flex-end;">
            <button class="action-btn" id="btnExport"><i class="fa-solid fa-file-csv"></i> Export CSV</button>
          </div>
        </div>
      </section>

      <section class="form-container">
        <h3><i class="fa-solid fa-chart-simple"></i> Recent Activity</h3>
        <div id="activityList" class="record-list"></div>
      </section>
    </main>
  </div>

  <script src="rbac.js"></script>
  <script>
    // Sidebar collapse toggle
    const btn = document.getElementById('btnToggle');
    const sidebar = document.getElementById('sidebar');
    if (btn && sidebar) {
      btn.addEventListener('click', () => sidebar.classList.toggle('collapsed'));
    }

    // Pull from localStorage datasets
    const APPT_KEY = 'hms_appointments';
    const INV_KEY = 'hms_invoices';
    const PAY_KEY = 'hms_payments';

    function peso(n){ return '₱' + (Number(n||0)).toLocaleString(undefined, {minimumFractionDigits:2, maximumFractionDigits:2}); }

    function loadKPIs(){
      const appts = JSON.parse(localStorage.getItem(APPT_KEY)||'[]');
      const today = new Date(); today.setHours(0,0,0,0);
      const countToday = appts.filter(a=>{const d=new Date(a.when); d.setHours(0,0,0,0); return d.getTime()===today.getTime();}).length;
      document.getElementById('kpiAppt').textContent = countToday;

      const inv = JSON.parse(localStorage.getItem(INV_KEY)||'[]');
      const outstanding = inv.reduce((s,i)=> s + Math.max(0,(i.total||0) - (i.paid||0)),0);
      document.getElementById('kpiOutstanding').textContent = peso(outstanding);

      // Placeholder metrics
      document.getElementById('kpiLab').textContent = 0;
      document.getElementById('kpiStock').textContent = 0;
    }

    function exportCSV(){
      const ds = document.getElementById('dataset').value;
      let rows = [];
      if (ds==='appointments') {
        const data = JSON.parse(localStorage.getItem(APPT_KEY)||'[]');
        rows = [['ID','Patient','Doctor','When','Duration','Status','Reason'], ...data.map(a=>[a.id,a.patient,a.doctor,a.when,a.duration||'',a.status||'',a.reason||''])];
      } else if (ds==='invoices') {
        const data = JSON.parse(localStorage.getItem(INV_KEY)||'[]');
        rows = [['ID','Patient','Invoice #','Total','Paid','Status'], ...data.map(i=>[i.id||'',i.patient||'',i.number||'',i.total||0,i.paid||0,i.status||''])];
      } else if (ds==='payments') {
        const data = JSON.parse(localStorage.getItem(PAY_KEY)||'[]');
        rows = [['ID','Invoice #','Amount','Method','Ref','Date'], ...data.map(p=>[p.id||'',p.invoiceNumber||'',p.amount||0,p.method||'',p.reference||'',p.date||''])];
      }
      const csv = rows.map(r=>r.map(x=>`"${String(x).replace(/"/g,'""')}"`).join(',')).join('\n');
      const blob = new Blob([csv], {type:'text/csv'});
      const a = document.createElement('a');
      a.href = URL.createObjectURL(blob);
      a.download = ds + '-' + new Date().toISOString().slice(0,10) + '.csv';
      a.click();
    }

    function loadActivity(){
      const appts = JSON.parse(localStorage.getItem(APPT_KEY)||'[]').slice(-5);
      const pays = JSON.parse(localStorage.getItem(PAY_KEY)||'[]').slice(-5);
      const list = document.getElementById('activityList');
      const items = [];
      appts.reverse().forEach(a=> items.push(`<div class="record"><p><strong>Appointment</strong> · ${a.patient} with ${a.doctor}</p><span class="muted">${new Date(a.when).toLocaleString()}</span></div>`));
      pays.reverse().forEach(p=> items.push(`<div class="record"><p><strong>Payment</strong> · ${p.invoiceNumber}</p><span class="muted">${peso(p.amount)} · ${p.method}</span></div>`));
      if (!items.length) { list.innerHTML = '<p class="muted">No recent activity.</p>'; return; }
      list.innerHTML = items.join('');
    }

    document.getElementById('btnExport').onclick = exportCSV;
    loadKPIs();
    loadActivity();
  </script>
</body>
</html>
